import{transformMat4 as t,length as s}from"gl-matrix/vec3";import{determinant as e,getRotation as i,multiply as r}from"gl-matrix/mat4";const n="v0.12.16",h="@glb.bin";var o,u,c,a;function l(t,s,e,i){var r,n=arguments.length,h=n<3?s:null===i?i=Object.getOwnPropertyDescriptor(s,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,s,e,i);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(h=(n<3?r(h):n>3?r(s,e,h):r(s,e))||h);return n>3&&h&&Object.defineProperty(s,e,h),h}!function(t){t.ACCESSOR="Accessor",t.ANIMATION="Animation",t.ANIMATION_CHANNEL="AnimationChannel",t.ANIMATION_SAMPLER="AnimationSampler",t.BUFFER="Buffer",t.CAMERA="Camera",t.MATERIAL="Material",t.MESH="Mesh",t.PRIMITIVE="Primitive",t.PRIMITIVE_TARGET="PrimitiveTarget",t.NODE="Node",t.ROOT="Root",t.SCENE="Scene",t.SKIN="Skin",t.TEXTURE="Texture",t.TEXTURE_INFO="TextureInfo"}(o||(o={})),function(t){t.INTERLEAVED="interleaved",t.SEPARATE="separate"}(u||(u={})),function(t){t[t.R=4096]="R",t[t.G=256]="G",t[t.B=16]="B",t[t.A=1]="A"}(c||(c={})),function(t){t.GLTF="GLTF",t.GLB="GLB"}(a||(a={}));class f{constructor(t,s,e){if(this.t=void 0,this.i=void 0,this.h=void 0,this.o=!1,this.u=[],this.t=t,this.i=s,this.h=e,!s.canLink(e))throw new Error("Cannot link disconnected graphs/documents.")}getName(){return this.t}getParent(){return this.i}getChild(){return this.h}setChild(t){return this.h=t,this}dispose(){this.o||(this.o=!0,this.u.forEach(t=>t()),this.u.length=0)}onDispose(t){return this.u.push(t),this}isDisposed(){return this.o}}class d{constructor(){this.l=new Set,this.p=new Set,this.g=new Map,this.v=new Map,this.u={}}on(t,s){return this.u[t]=this.u[t]||[],this.u[t].push(s),this}emit(t,s){for(const e of this.u[t]||[])e(s);return this}getLinks(){return Array.from(this.p)}listParentLinks(t){return Array.from(this.v.get(t)||this.l)}listParents(t){return this.listParentLinks(t).map(t=>t.getParent())}listChildLinks(t){return Array.from(this.g.get(t)||this.l)}listChildren(t){return this.listChildLinks(t).map(t=>t.getChild())}disconnectChildren(t){return(this.g.get(t)||this.l).forEach(t=>t.dispose()),this}disconnectParents(t,s){let e=Array.from(this.v.get(t)||this.l);return s&&(e=e.filter(t=>s(t.getParent()))),e.forEach(t=>t.dispose()),this}swapChild(t,s,e){const i=this.g.get(t)||this.l;return Array.from(i).filter(t=>t.getChild()===s).forEach(t=>{this.v.get(s).delete(t),t.setChild(e),this.v.has(e)||this.v.set(e,new Set),this.v.get(e).add(t)}),this}link(t,s,e){if(!e)return null;const i=new f(t,s,e);return this.registerLink(i),i}registerLink(t){this.p.add(t);const s=t.getParent();this.g.has(s)||this.g.set(s,new Set),this.g.get(s).add(t);const e=t.getChild();return this.v.has(e)||this.v.set(e,new Set),this.v.get(e).add(t),t.onDispose(()=>this.unlink(t)),t}unlink(t){return this.p.delete(t),this.g.get(t.getParent()).delete(t),this.v.get(t.getChild()).delete(t),this}}function p(t,s){Object.defineProperty(t,s,{get:function(){return this["__"+s]},set:function(t){const e=this["__"+s];e&&!Array.isArray(e)&&e.dispose(),t&&!Array.isArray(t)&&t.onDispose(()=>{this["__"+s]=null}),this["__"+s]=t},enumerable:!0})}function g(t,s){}function w(t){const s={min:[Infinity,Infinity,Infinity],max:[-Infinity,-Infinity,-Infinity]},e=t.propertyType===o.NODE?[t]:t.listChildren();for(const t of e)t.traverse(t=>{const e=t.getMesh();if(!e)return;const i=v(e,t.getWorldMatrix());m(i.min,s),m(i.max,s)});return s}function v(s,e){const i={min:[Infinity,Infinity,Infinity],max:[-Infinity,-Infinity,-Infinity]};for(const r of s.listPrimitives()){const s=r.getAttribute("POSITION");if(!s)continue;let n=[0,0,0],h=[0,0,0];for(let r=0;r<s.getCount();r++)n=s.getElement(r,n),h=t(h,n,e),m(h,i)}return i}function m(t,s){for(let e=0;e<3;e++)s.min[e]=Math.min(t[e],s.min[e]),s.max[e]=Math.max(t[e],s.max[e])}class T{static createBufferFromDataURI(t){if("undefined"==typeof Buffer){const s=atob(t.split(",")[1]),e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e.buffer}{const s=t.split(",")[1],e=t.indexOf("base64")>=0;return this.trim(Buffer.from(s,e?"base64":"utf8"))}}static encodeText(t){return"undefined"!=typeof TextEncoder?(new TextEncoder).encode(t).buffer:this.trim(Buffer.from(t))}static decodeText(t){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(t):Buffer.from(t).toString("utf8")}static trim(t){const{byteOffset:s,byteLength:e}=t;return t.buffer.slice(s,s+e)}static concat(t){let s=0;for(const e of t)s+=e.byteLength;const e=new Uint8Array(s);let i=0;for(const s of t)e.set(new Uint8Array(s),i),i+=s.byteLength;return e.buffer}static pad(t,s=0){const e=this.padNumber(t.byteLength);if(e!==t.byteLength){const i=new Uint8Array(e);if(i.set(new Uint8Array(t)),0!==s)for(let r=t.byteLength;r<e;r++)i[r]=s;return i.buffer}return t}static padNumber(t){return 4*Math.ceil(t/4)}static equals(t,s){if(t===s)return!0;if(t.byteLength!==s.byteLength)return!1;const e=new DataView(t),i=new DataView(s);let r=t.byteLength;for(;r--;)if(e.getUint8(r)!==i.getUint8(r))return!1;return!0}}class y{static hexToFactor(t,s){t=Math.floor(t);const e=s;return e[0]=(t>>16&255)/255,e[1]=(t>>8&255)/255,e[2]=(255&t)/255,this.convertSRGBToLinear(s,s)}static factorToHex(t){const s=[...t],[e,i,r]=this.convertLinearToSRGB(t,s);return 255*e<<16^255*i<<8^255*r<<0}static convertSRGBToLinear(t,s){const e=t,i=s;for(let t=0;t<3;t++)i[t]=e[t]<.04045?.0773993808*e[t]:Math.pow(.9478672986*e[t]+.0521327014,2.4);return s}static convertLinearToSRGB(t,s){const e=t,i=s;for(let t=0;t<3;t++)i[t]=e[t]<.0031308?12.92*e[t]:1.055*Math.pow(e[t],.41666)-.055;return s}}class A{static basename(t){const s=t.split(/[\\/]/).pop();return s.substr(0,s.lastIndexOf("."))}static extension(t){return 0!==t.indexOf("data:")?t.split(/[\\/]/).pop().split(/[.]/).pop():0===t.indexOf("data:image/png")?"png":0===t.indexOf("data:image/jpeg")?"jpeg":"bin"}}class x{getSize(t){const s=new DataView(t);return T.decodeText(t.slice(12,16))===x.PNG_FRIED_CHUNK_NAME?[s.getUint32(32,!1),s.getUint32(36,!1)]:[s.getUint32(16,!1),s.getUint32(20,!1)]}getChannels(t){return 4}}x.PNG_FRIED_CHUNK_NAME="CgBI";class E{static registerFormat(t,s){this.impls[t]=s}static getSize(t,s){return this.impls[s]?this.impls[s].getSize(t):null}static getChannels(t,s){return this.impls[s]?this.impls[s].getChannels(t):null}static getMemSize(t,s){if(!this.impls[s])return null;if(this.impls[s].getGPUByteLength)return this.impls[s].getGPUByteLength(t);let e=0;const i=this.getSize(t,s);if(!i)return null;for(;i[0]>1||i[1]>1;)e+=i[0]*i[1]*4,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return e+=4,e}static mimeTypeToExtension(t){return"image/jpeg"===t?"jpg":t.split("/").pop()}static extensionToMimeType(t){return"jpg"===t?"image/jpeg":`image/${t}`}}function M(t,s){if(s>t.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(255!==t.getUint8(s))throw new TypeError("Invalid JPG, marker table corrupted");return t}E.impls={"image/jpeg":new class{getSize(t){let s,e,i=new DataView(t,4);for(;i.byteLength;){if(s=i.getUint16(0,!1),M(i,s),e=i.getUint8(s+1),192===e||193===e||194===e)return[i.getUint16(s+7,!1),i.getUint16(s+5,!1)];i=new DataView(t,i.byteOffset+s+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(t){return 3}},"image/png":new x};class S{static identity(t){return t}static eq(t,s){if(t.length!==s.length)return!1;for(let e=0;e<t.length;e++)if(Math.abs(t[e]-s[e])>1e-5)return!1;return!0}static denormalize(t,s){switch(s){case 5126:return t;case 5123:return t/65535;case 5121:return t/255;case 5122:return Math.max(t/32767,-1);case 5120:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}static normalize(t,s){switch(s){case 5126:return t;case 5123:return Math.round(65535*t);case 5121:return Math.round(255*t);case 5122:return Math.round(32767*t);case 5120:return Math.round(127*t);default:throw new Error("Invalid component type.")}}static decompose(t,r,n,h){let o=s([t[0],t[1],t[2]]);const u=s([t[4],t[5],t[6]]),c=s([t[8],t[9],t[10]]);e(t)<0&&(o=-o),r[0]=t[12],r[1]=t[13],r[2]=t[14];const a=t.slice(),l=1/o,f=1/u,d=1/c;a[0]*=l,a[1]*=l,a[2]*=l,a[4]*=f,a[5]*=f,a[6]*=f,a[8]*=d,a[9]*=d,a[10]*=d,i(n,a),h[0]=o,h[1]=u,h[2]=c}static compose(t,s,e,i){const r=i,n=s[0],h=s[1],o=s[2],u=s[3],c=n+n,a=h+h,l=o+o,f=n*c,d=n*a,p=n*l,g=h*a,w=h*l,v=o*l,m=u*c,T=u*a,y=u*l,A=e[0],x=e[1],E=e[2];return r[0]=(1-(g+v))*A,r[1]=(d+y)*A,r[2]=(p-T)*A,r[3]=0,r[4]=(d-y)*x,r[5]=(1-(f+v))*x,r[6]=(w+m)*x,r[7]=0,r[8]=(p+T)*E,r[9]=(w-m)*E,r[10]=(1-(f+g))*E,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}}class I{constructor(t){this.verbosity=void 0,this.verbosity=t}debug(t){this.verbosity<=I.Verbosity.DEBUG&&console.debug(t)}info(t){this.verbosity<=I.Verbosity.INFO&&console.info(t)}warn(t){this.verbosity<=I.Verbosity.WARN&&console.warn(t)}error(t){this.verbosity<=I.Verbosity.ERROR&&console.error(t)}}I.Verbosity={SILENT:4,ERROR:3,WARN:2,INFO:1,DEBUG:0},I.DEFAULT_INSTANCE=new I(I.Verbosity.INFO);const b="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",R=new Set,N=function(){let t="";for(let s=0;s<6;s++)t+=b.charAt(Math.floor(Math.random()*b.length));return t},C=function(){for(let t=0;t<999;t++){const t=N();if(!R.has(t))return R.add(t),t}return""},_=t=>t;class O extends class{constructor(t){this.graph=void 0,this.o=!1,this.graph=t,this.graph=t}canLink(t){return this.graph===t.graph}isDisposed(){return this.o}dispose(){this.graph.disconnectChildren(this),this.graph.disconnectParents(this),this.o=!0,this.graph.emit("dispose",this)}detach(){return this.graph.disconnectParents(this),this}swap(t,s){return this.graph.swapChild(this,t,s),this}addGraphChild(t,s){return t.push(s),s.onDispose(()=>{const e=t.filter(t=>t!==s);t.length=0;for(const s of e)t.push(s)}),this}removeGraphChild(t,s){return t.filter(t=>t.getChild()===s).forEach(t=>t.dispose()),this}clearGraphChildList(t){for(;t.length>0;)t[0].dispose();return this}listGraphParents(){return this.graph.listParents(this)}}{constructor(t,s=""){super(t),this.graph=void 0,this.m={},this.t="",this.graph=t,this.t=s}getName(){return this.t}setName(t){return this.t=t,this}getExtras(){return this.m}setExtras(t){return this.m=t,this}clone(){const t=new(0,this.constructor)(this.graph).copy(this,_);return this.graph.emit("clone",t),t}copy(t,s=_){return this.t=t.t,this.m=JSON.parse(JSON.stringify(t.m)),this}detach(){return this.graph.disconnectParents(this,t=>"Root"!==t.propertyType),this}listParents(){return this.listGraphParents()}}const L="Pass extension name (string) as lookup token, not a constructor.";class B extends O{constructor(...t){super(...t),this.extensions=[]}copy(t,s=_){return super.copy(t,s),this.clearGraphChildList(this.extensions),t.extensions.forEach(t=>{const e=t.getChild();this.setExtension(e.extensionName,s(e))}),this}getExtension(t){if("string"!=typeof t)throw new Error(L);const s=this.extensions.find(s=>s.getChild().extensionName===t);return s?s.getChild():null}setExtension(t,s){if("string"!=typeof t)throw new Error(L);const e=this.getExtension(t);return e&&this.removeGraphChild(this.extensions,e),s?(s.T(this),this.addGraphChild(this.extensions,this.graph.link(t,this,s))):this}listExtensions(){return this.extensions.map(t=>t.getChild())}}l([g],B.prototype,"extensions",void 0);class P extends B{constructor(...t){super(...t),this.propertyType=o.ACCESSOR,this.M=null,this.S=P.Type.SCALAR,this.I=P.ComponentType.FLOAT,this.N=!1,this.C=S.identity,this._=S.identity,this.buffer=null}copy(t,s=_){return super.copy(t,s),this.S=t.S,this.I=t.I,this.N=t.N,this.C=t.C,this._=t._,t.M&&(this.M=t.M.slice()),this.setBuffer(t.buffer?s(t.buffer.getChild()):null),this}static getElementSize(t){switch(t){case P.Type.SCALAR:return 1;case P.Type.VEC2:return 2;case P.Type.VEC3:return 3;case P.Type.VEC4:case P.Type.MAT2:return 4;case P.Type.MAT3:return 9;case P.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+t)}}static getComponentSize(t){switch(t){case P.ComponentType.BYTE:case P.ComponentType.UNSIGNED_BYTE:return 1;case P.ComponentType.SHORT:case P.ComponentType.UNSIGNED_SHORT:return 2;case P.ComponentType.UNSIGNED_INT:case P.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+t)}}getMinNormalized(t){const s=this.getElementSize();this.getMin(t);for(let e=0;e<s;e++)t[e]=this._(t[e]);return t}getMin(t){const s=this.getCount(),e=this.getElementSize();for(let s=0;s<e;s++)t[s]=Infinity;for(let i=0;i<s*e;i+=e)for(let s=0;s<e;s++){const e=this.M[i+s];Number.isFinite(e)&&(t[s]=Math.min(t[s],e))}return t}getMaxNormalized(t){const s=this.getElementSize();this.getMax(t);for(let e=0;e<s;e++)t[e]=this._(t[e]);return t}getMax(t){const s=this.getCount(),e=this.getElementSize();for(let s=0;s<e;s++)t[s]=-Infinity;for(let i=0;i<s*e;i+=e)for(let s=0;s<e;s++){const e=this.M[i+s];Number.isFinite(e)&&(t[s]=Math.max(t[s],e))}return t}getCount(){return this.M?this.M.length/this.getElementSize():0}getType(){return this.S}setType(t){return this.S=t,this}getElementSize(){return P.getElementSize(this.S)}getComponentSize(){return this.M.BYTES_PER_ELEMENT}getComponentType(){return this.I}getNormalized(){return this.N}setNormalized(t){return this.N=t,t?(this._=t=>S.denormalize(t,this.I),this.C=t=>S.normalize(t,this.I)):(this._=S.identity,this.C=S.identity),this}getScalar(t){const s=this.getElementSize();return this._(this.M[t*s])}setScalar(t,s){return this.M[t*this.getElementSize()]=this.C(s),this}getElement(t,s){const e=this.getElementSize();for(let i=0;i<e;i++)s[i]=this._(this.M[t*e+i]);return s}setElement(t,s){const e=this.getElementSize();for(let i=0;i<e;i++)this.M[t*e+i]=this.C(s[i]);return this}getBuffer(){return this.buffer?this.buffer.getChild():null}setBuffer(t){return this.buffer=this.graph.link("buffer",this,t),this}getArray(){return this.M}setArray(t){return this.I=t?function(t){switch(t.constructor){case Float32Array:return P.ComponentType.FLOAT;case Uint32Array:return P.ComponentType.UNSIGNED_INT;case Uint16Array:return P.ComponentType.UNSIGNED_SHORT;case Uint8Array:return P.ComponentType.UNSIGNED_BYTE;case Int16Array:return P.ComponentType.SHORT;case Int8Array:return P.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(t):P.ComponentType.FLOAT,this.M=t,this}getByteLength(){return this.M?this.M.byteLength:0}}P.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},P.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126},l([p],P.prototype,"buffer",void 0);class U extends B{constructor(...t){super(...t),this.propertyType=o.ANIMATION,this.channels=[],this.samplers=[]}copy(t,s=_){return super.copy(t,s),this.clearGraphChildList(this.channels),this.clearGraphChildList(this.samplers),t.channels.forEach(t=>this.addChannel(s(t.getChild()))),t.samplers.forEach(t=>this.addSampler(s(t.getChild()))),this}addChannel(t){const s=this.graph.link("channel",this,t);return this.addGraphChild(this.channels,s)}removeChannel(t){return this.removeGraphChild(this.channels,t)}listChannels(){return this.channels.map(t=>t.getChild())}addSampler(t){const s=this.graph.link("sampler",this,t);return this.addGraphChild(this.samplers,s)}removeSampler(t){return this.removeGraphChild(this.samplers,t)}listSamplers(){return this.samplers.map(t=>t.getChild())}}l([g],U.prototype,"channels",void 0),l([g],U.prototype,"samplers",void 0);class k extends O{constructor(...t){super(...t),this.propertyType=o.ANIMATION_CHANNEL,this.O=null,this.targetNode=null,this.sampler=null}copy(t,s=_){return super.copy(t,s),this.O=t.O,this.setTargetNode(t.targetNode?s(t.targetNode.getChild()):null),this.setSampler(t.sampler?s(t.sampler.getChild()):null),this}getTargetPath(){return this.O}setTargetPath(t){return this.O=t,this}getTargetNode(){return this.targetNode?this.targetNode.getChild():null}setTargetNode(t){return this.targetNode=this.graph.link("target.node",this,t),this}getSampler(){return this.sampler?this.sampler.getChild():null}setSampler(t){return this.sampler=this.graph.link("sampler",this,t),this}}k.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"},l([p],k.prototype,"targetNode",void 0),l([p],k.prototype,"sampler",void 0);class F extends O{constructor(...t){super(...t),this.propertyType=o.ANIMATION_SAMPLER,this.L=F.Interpolation.LINEAR,this.input=null,this.output=null}copy(t,s=_){return super.copy(t,s),this.L=t.L,this.setInput(t.input?s(t.input.getChild()):null),this.setOutput(t.output?s(t.output.getChild()):null),this}getInterpolation(){return this.L}setInterpolation(t){return this.L=t,this}getInput(){return this.input?this.input.getChild():null}setInput(t){return this.input=this.graph.link("input",this,t),this}getOutput(){return this.output?this.output.getChild():null}setOutput(t){return this.output=this.graph.link("output",this,t),this}}F.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"},l([p],F.prototype,"input",void 0),l([p],F.prototype,"output",void 0);class G extends B{constructor(...t){super(...t),this.propertyType=o.BUFFER,this.P=""}copy(t,s=_){return super.copy(t,s),this.P=t.P,this}getURI(){return this.P}setURI(t){return this.P=t,this}}class j extends B{constructor(...t){super(...t),this.propertyType=o.CAMERA,this.S=j.Type.PERSPECTIVE,this.U=.1,this.k=100,this.F=null,this.j=2*Math.PI*50/360,this.D=1,this.J=1}copy(t,s=_){return super.copy(t,s),this.S=t.S,this.U=t.U,this.k=t.k,this.F=t.F,this.j=t.j,this.D=t.D,this.J=t.J,this}getType(){return this.S}setType(t){return this.S=t,this}getZNear(){return this.U}setZNear(t){return this.U=t,this}getZFar(){return this.k}setZFar(t){return this.k=t,this}getAspectRatio(){return this.F}setAspectRatio(t){return this.F=t,this}getYFov(){return this.j}setYFov(t){return this.j=t,this}getXMag(){return this.D}setXMag(t){return this.D=t,this}getYMag(){return this.J}setYMag(t){return this.J=t,this}}j.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class D extends O{constructor(t,s){super(t),this.$=void 0,this.$=s,this.$.addExtensionProperty(this)}clone(){const t=new(0,this.constructor)(this.graph,this.$).copy(this,_);return this.graph.emit("clone",t),t}dispose(){this.$.removeExtensionProperty(this),super.dispose()}T(t){if(!this.parentTypes.includes(t.propertyType))throw new Error(`Parent "${t.propertyType}" invalid for child "${this.propertyType}".`)}}D.EXTENSION_NAME=void 0;class J extends f{constructor(...t){super(...t),this.semantic=""}copy(t){return this.semantic=t.semantic,this}}class z extends f{copy(t){return this}}class $ extends f{constructor(...t){super(...t),this.channels=0}copy(t){return this.channels=t.channels,this}}class V extends d{linkAttribute(t,s,e){if(!e)return null;const i=new J(t,s,e);return i.semantic=t,this.registerLink(i),i}linkIndex(t,s,e){if(!e)return null;const i=new z(t,s,e);return this.registerLink(i),i}linkTexture(t,s,e,i){if(!i)return null;const r=new $(t,e,i);return r.channels=s,this.registerLink(r),r}}class W extends B{constructor(...t){super(...t),this.propertyType=o.TEXTURE_INFO,this.V=0,this.W=null,this.Y=null,this.q=W.WrapMode.REPEAT,this.H=W.WrapMode.REPEAT}copy(t,s=_){return super.copy(t,s),this.V=t.V,this.W=t.W,this.Y=t.Y,this.q=t.q,this.H=t.H,this}getTexCoord(){return this.V}setTexCoord(t){return this.V=t,this}getMagFilter(){return this.W}setMagFilter(t){return this.W=t,this}getMinFilter(){return this.Y}setMinFilter(t){return this.Y=t,this}getWrapS(){return this.q}setWrapS(t){return this.q=t,this}getWrapT(){return this.H}setWrapT(t){return this.H=t,this}}W.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},W.MagFilter={NEAREST:9728,LINEAR:9729},W.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:Y,G:q,B:H,A:Z}=c;class K extends B{constructor(...t){super(...t),this.propertyType=o.MATERIAL,this.Z=K.AlphaMode.OPAQUE,this.K=.5,this.X=!1,this.tt=[1,1,1,1],this.st=[0,0,0],this.et=1,this.it=1,this.rt=1,this.nt=1,this.baseColorTexture=null,this.baseColorTextureInfo=this.graph.link("baseColorTextureInfo",this,new W(this.graph)),this.emissiveTexture=null,this.emissiveTextureInfo=this.graph.link("emissiveTextureInfo",this,new W(this.graph)),this.normalTexture=null,this.normalTextureInfo=this.graph.link("normalTextureInfo",this,new W(this.graph)),this.occlusionTexture=null,this.occlusionTextureInfo=this.graph.link("occlusionTextureInfo",this,new W(this.graph)),this.metallicRoughnessTexture=null,this.metallicRoughnessTextureInfo=this.graph.link("metallicRoughnessTextureInfo",this,new W(this.graph))}copy(t,s=_){return super.copy(t,s),this.Z=t.Z,this.K=t.K,this.X=t.X,this.tt=[...t.tt],this.st=[...t.st],this.et=t.et,this.it=t.it,this.rt=t.rt,this.nt=t.nt,this.setBaseColorTexture(t.baseColorTexture?s(t.baseColorTexture.getChild()):null),this.baseColorTextureInfo.getChild().copy(s(t.baseColorTextureInfo.getChild()),s),this.setEmissiveTexture(t.emissiveTexture?s(t.emissiveTexture.getChild()):null),this.emissiveTextureInfo.getChild().copy(s(t.emissiveTextureInfo.getChild()),s),this.setNormalTexture(t.normalTexture?s(t.normalTexture.getChild()):null),this.normalTextureInfo.getChild().copy(s(t.normalTextureInfo.getChild()),s),this.setOcclusionTexture(t.occlusionTexture?s(t.occlusionTexture.getChild()):null),this.occlusionTextureInfo.getChild().copy(s(t.occlusionTextureInfo.getChild()),s),this.setMetallicRoughnessTexture(t.metallicRoughnessTexture?s(t.metallicRoughnessTexture.getChild()):null),this.metallicRoughnessTextureInfo.getChild().copy(s(t.metallicRoughnessTextureInfo.getChild()),s),this}dispose(){this.baseColorTextureInfo.getChild().dispose(),this.emissiveTextureInfo.getChild().dispose(),this.normalTextureInfo.getChild().dispose(),this.occlusionTextureInfo.getChild().dispose(),this.metallicRoughnessTextureInfo.getChild().dispose(),super.dispose()}getDoubleSided(){return this.X}setDoubleSided(t){return this.X=t,this}getAlpha(){return this.tt[3]}setAlpha(t){return this.tt[3]=t,this}getAlphaMode(){return this.Z}setAlphaMode(t){return this.Z=t,this}getAlphaCutoff(){return this.K}setAlphaCutoff(t){return this.K=t,this}getBaseColorFactor(){return this.tt}setBaseColorFactor(t){return this.tt=t,this}getBaseColorHex(){return y.factorToHex(this.tt)}setBaseColorHex(t){return y.hexToFactor(t,this.tt),this}getBaseColorTexture(){return this.baseColorTexture?this.baseColorTexture.getChild():null}getBaseColorTextureInfo(){return this.baseColorTexture?this.baseColorTextureInfo.getChild():null}setBaseColorTexture(t){return this.baseColorTexture=this.graph.linkTexture("baseColorTexture",Y|q|H|Z,this,t),this}getEmissiveFactor(){return this.st}setEmissiveFactor(t){return this.st=t,this}getEmissiveHex(){return y.factorToHex(this.st)}setEmissiveHex(t){return y.hexToFactor(t,this.st),this}getEmissiveTexture(){return this.emissiveTexture?this.emissiveTexture.getChild():null}getEmissiveTextureInfo(){return this.emissiveTexture?this.emissiveTextureInfo.getChild():null}setEmissiveTexture(t){return this.emissiveTexture=this.graph.linkTexture("emissiveTexture",Y|q|H,this,t),this}getNormalScale(){return this.et}setNormalScale(t){return this.et=t,this}getNormalTexture(){return this.normalTexture?this.normalTexture.getChild():null}getNormalTextureInfo(){return this.normalTexture?this.normalTextureInfo.getChild():null}setNormalTexture(t){return this.normalTexture=this.graph.linkTexture("normalTexture",Y|q|H,this,t),this}getOcclusionStrength(){return this.it}setOcclusionStrength(t){return this.it=t,this}getOcclusionTexture(){return this.occlusionTexture?this.occlusionTexture.getChild():null}getOcclusionTextureInfo(){return this.occlusionTexture?this.occlusionTextureInfo.getChild():null}setOcclusionTexture(t){return this.occlusionTexture=this.graph.linkTexture("occlusionTexture",Y,this,t),this}getRoughnessFactor(){return this.rt}setRoughnessFactor(t){return this.rt=t,this}getMetallicFactor(){return this.nt}setMetallicFactor(t){return this.nt=t,this}getMetallicRoughnessTexture(){return this.metallicRoughnessTexture?this.metallicRoughnessTexture.getChild():null}getMetallicRoughnessTextureInfo(){return this.metallicRoughnessTexture?this.metallicRoughnessTextureInfo.getChild():null}setMetallicRoughnessTexture(t){return this.metallicRoughnessTexture=this.graph.linkTexture("metallicRoughnessTexture",q|H,this,t),this}}K.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"},l([p],K.prototype,"baseColorTexture",void 0),l([p],K.prototype,"baseColorTextureInfo",void 0),l([p],K.prototype,"emissiveTexture",void 0),l([p],K.prototype,"emissiveTextureInfo",void 0),l([p],K.prototype,"normalTexture",void 0),l([p],K.prototype,"normalTextureInfo",void 0),l([p],K.prototype,"occlusionTexture",void 0),l([p],K.prototype,"occlusionTextureInfo",void 0),l([p],K.prototype,"metallicRoughnessTexture",void 0),l([p],K.prototype,"metallicRoughnessTextureInfo",void 0);class Q extends B{constructor(...t){super(...t),this.propertyType=o.MESH,this.ht=[],this.primitives=[]}copy(t,s=_){return super.copy(t,s),this.ht=[...t.ht],this.clearGraphChildList(this.primitives),t.primitives.forEach(t=>this.addPrimitive(s(t.getChild()))),this}addPrimitive(t){return this.addGraphChild(this.primitives,this.graph.link("primitive",this,t))}removePrimitive(t){return this.removeGraphChild(this.primitives,t)}listPrimitives(){return this.primitives.map(t=>t.getChild())}getWeights(){return this.ht}setWeights(t){return this.ht=t,this}}l([g],Q.prototype,"primitives",void 0);class X extends B{constructor(...t){super(...t),this.propertyType=o.NODE,this.ot=[0,0,0],this.ut=[0,0,0,1],this.ct=[1,1,1],this.ht=[],this.i=null,this.camera=null,this.mesh=null,this.skin=null,this.children=[]}copy(t,s=_){return super.copy(t,s),this.ot=[...t.ot],this.ut=[...t.ut],this.ct=[...t.ct],this.ht=[...t.ht],this.setCamera(t.camera?s(t.camera.getChild()):null),this.setMesh(t.mesh?s(t.mesh.getChild()):null),this.setSkin(t.skin?s(t.skin.getChild()):null),s!==_&&(this.clearGraphChildList(this.children),t.children.forEach(t=>this.addChild(s(t.getChild())))),this}getTranslation(){return this.ot}getRotation(){return this.ut}getScale(){return this.ct}setTranslation(t){return this.ot=t,this}setRotation(t){return this.ut=t,this}setScale(t){return this.ct=t,this}getMatrix(){return S.compose(this.ot,this.ut,this.ct,[])}setMatrix(t){return S.decompose(t,this.ot,this.ut,this.ct),this}getWorldTranslation(){const t=[0,0,0];return S.decompose(this.getWorldMatrix(),t,[0,0,0,1],[1,1,1]),t}getWorldRotation(){const t=[0,0,0,1];return S.decompose(this.getWorldMatrix(),[0,0,0],t,[1,1,1]),t}getWorldScale(){const t=[1,1,1];return S.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],t),t}getWorldMatrix(){const t=[];for(let s=this;s instanceof X;s=s.i)t.push(s);let s;const e=t.pop().getMatrix();for(;s=t.pop();)r(e,e,s.getMatrix());return e}addChild(t){t.i&&t.i.removeChild(t);const s=this.graph.link("child",this,t);return this.addGraphChild(this.children,s),t.i=this,s.onDispose(()=>t.i=null),this}removeChild(t){return this.removeGraphChild(this.children,t)}listChildren(){return this.children.map(t=>t.getChild())}getParent(){return this.i}getMesh(){return this.mesh?this.mesh.getChild():null}setMesh(t){return this.mesh=this.graph.link("mesh",this,t),this}getCamera(){return this.camera?this.camera.getChild():null}setCamera(t){return this.camera=this.graph.link("camera",this,t),this}getSkin(){return this.skin?this.skin.getChild():null}setSkin(t){return this.skin=this.graph.link("skin",this,t),this}getWeights(){return this.ht}setWeights(t){return this.ht=t,this}traverse(t){t(this);for(const s of this.listChildren())s.traverse(t);return this}}l([p],X.prototype,"camera",void 0),l([p],X.prototype,"mesh",void 0),l([p],X.prototype,"skin",void 0),l([g],X.prototype,"children",void 0);class tt extends B{constructor(...t){super(...t),this.propertyType=o.PRIMITIVE,this.at=tt.Mode.TRIANGLES,this.material=null,this.indices=null,this.attributes=[],this.targets=[]}copy(t,s=_){return super.copy(t,s),this.at=t.at,this.setIndices(t.indices?s(t.indices.getChild()):null),this.setMaterial(t.material?s(t.material.getChild()):null),this.clearGraphChildList(this.attributes),t.listSemantics().forEach(e=>{this.setAttribute(e,s(t.getAttribute(e)))}),this.clearGraphChildList(this.targets),t.targets.forEach(t=>this.addTarget(s(t.getChild()))),this}getIndices(){return this.indices?this.indices.getChild():null}setIndices(t){return this.indices=this.graph.linkIndex("indices",this,t),this}getAttribute(t){const s=this.attributes.find(s=>s.semantic===t);return s?s.getChild():null}setAttribute(t,s){const e=this.getAttribute(t);if(e&&this.removeGraphChild(this.attributes,e),!s)return this;const i=this.graph.linkAttribute(t,this,s);return this.addGraphChild(this.attributes,i)}listAttributes(){return this.attributes.map(t=>t.getChild())}listSemantics(){return this.attributes.map(t=>t.semantic)}getMaterial(){return this.material?this.material.getChild():null}setMaterial(t){return this.material=this.graph.link("material",this,t),this}getMode(){return this.at}setMode(t){return this.at=t,this}listTargets(){return this.targets.map(t=>t.getChild())}addTarget(t){return this.addGraphChild(this.targets,this.graph.link("target",this,t)),this}removeTarget(t){return this.removeGraphChild(this.targets,t)}}tt.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},l([p],tt.prototype,"material",void 0),l([p],tt.prototype,"indices",void 0),l([g],tt.prototype,"attributes",void 0),l([g],tt.prototype,"targets",void 0);class st extends O{constructor(...t){super(...t),this.propertyType=o.PRIMITIVE_TARGET,this.attributes=[]}copy(t,s=_){return super.copy(t,s),this.clearGraphChildList(this.attributes),t.listSemantics().forEach(e=>{this.setAttribute(e,s(t.getAttribute(e)))}),this}getAttribute(t){const s=this.attributes.find(s=>s.semantic===t);return s?s.getChild():null}setAttribute(t,s){const e=this.getAttribute(t);if(e&&this.removeGraphChild(this.attributes,e),!s)return this;const i=this.graph.linkAttribute(t,this,s);return i.semantic=t,this.addGraphChild(this.attributes,i)}listAttributes(){return this.attributes.map(t=>t.getChild())}listSemantics(){return this.attributes.map(t=>t.semantic)}}l([g],st.prototype,"attributes",void 0);class et extends B{constructor(...t){super(...t),this.propertyType=o.SCENE,this.children=[]}copy(t,s=_){return super.copy(t,s),s!==_&&(this.clearGraphChildList(this.children),t.children.forEach(t=>this.addChild(s(t.getChild())))),this}addChild(t){t.i&&t.i.removeChild(t);const s=this.graph.link("child",this,t);return this.addGraphChild(this.children,s),t.i=this,s.onDispose(()=>t.i=null),this}removeChild(t){return this.removeGraphChild(this.children,t)}listChildren(){return this.children.map(t=>t.getChild())}traverse(t){for(const s of this.listChildren())s.traverse(t);return this}}l([g],et.prototype,"children",void 0);class it extends B{constructor(...t){super(...t),this.propertyType=o.SKIN,this.skeleton=null,this.inverseBindMatrices=null,this.joints=[]}copy(t,s=_){return super.copy(t,s),this.setSkeleton(t.skeleton?s(t.skeleton.getChild()):null),this.setInverseBindMatrices(t.inverseBindMatrices?s(t.inverseBindMatrices.getChild()):null),this.clearGraphChildList(this.joints),t.joints.forEach(t=>this.addJoint(s(t.getChild()))),this}getSkeleton(){return this.skeleton?this.skeleton.getChild():null}setSkeleton(t){return this.skeleton=this.graph.link("skeleton",this,t),this}getInverseBindMatrices(){return this.inverseBindMatrices?this.inverseBindMatrices.getChild():null}setInverseBindMatrices(t){return this.inverseBindMatrices=this.graph.link("inverseBindMatrices",this,t),this}addJoint(t){const s=this.graph.link("joint",this,t);return this.addGraphChild(this.joints,s)}removeJoint(t){return this.removeGraphChild(this.joints,t)}listJoints(){return this.joints.map(t=>t.getChild())}}l([p],it.prototype,"skeleton",void 0),l([p],it.prototype,"inverseBindMatrices",void 0),l([g],it.prototype,"joints",void 0);class rt extends B{constructor(...t){super(...t),this.propertyType=o.TEXTURE,this.lt=null,this.ft="",this.P=""}copy(t,s=_){return super.copy(t,s),this.ft=t.ft,this.P=t.P,t.lt&&(this.lt=t.lt.slice(0)),this}getMimeType(){return this.ft||E.extensionToMimeType(A.extension(this.P))}setMimeType(t){return this.ft=t,this}getURI(){return this.P}setURI(t){return this.P=t,this.ft=E.extensionToMimeType(A.extension(t)),this}getImage(){return this.lt}setImage(t){return this.lt=t,this}getSize(){return this.lt?E.getSize(this.lt,this.getMimeType()):null}}class nt extends O{constructor(t){super(t),this.propertyType=o.ROOT,this.dt={generator:"glTF-Transform v0.12.16",version:"2.0"},this.gt=new Set,this.defaultScene=null,this.accessors=[],this.animations=[],this.buffers=[],this.cameras=[],this.materials=[],this.meshes=[],this.nodes=[],this.scenes=[],this.skins=[],this.textures=[],t.on("clone",t=>this.wt(t))}clone(){throw new Error("Root cannot be cloned.")}copy(t,s=_){if(super.copy(t,s),s===_)throw new Error("Root cannot be copied.");return Object.assign(this.dt,t.dt),t.accessors.forEach(t=>this.vt(s(t.getChild()))),t.animations.forEach(t=>this.Tt(s(t.getChild()))),t.buffers.forEach(t=>this.yt(s(t.getChild()))),t.cameras.forEach(t=>this.At(s(t.getChild()))),t.materials.forEach(t=>this.xt(s(t.getChild()))),t.meshes.forEach(t=>this.Et(s(t.getChild()))),t.nodes.forEach(t=>this.Mt(s(t.getChild()))),t.scenes.forEach(t=>this.St(s(t.getChild()))),t.skins.forEach(t=>this.It(s(t.getChild()))),t.textures.forEach(t=>this.bt(s(t.getChild()))),this.setDefaultScene(t.defaultScene?s(t.defaultScene.getChild()):null),this}wt(t){return t instanceof et?this.St(t):t instanceof X?this.Mt(t):t instanceof j?this.At(t):t instanceof it?this.It(t):t instanceof Q?this.Et(t):t instanceof K?this.xt(t):t instanceof rt?this.bt(t):t instanceof U?this.Tt(t):t instanceof P?this.vt(t):t instanceof G&&this.yt(t),this}getAsset(){return this.dt}listExtensionsUsed(){return Array.from(this.gt)}listExtensionsRequired(){return this.listExtensionsUsed().filter(t=>t.isRequired())}Rt(t){return this.gt.add(t),this}Nt(t){return this.gt.delete(t),this}St(t){return this.addGraphChild(this.scenes,this.graph.link("scene",this,t))}listScenes(){return this.scenes.map(t=>t.getChild())}setDefaultScene(t){return this.defaultScene=this.graph.link("scene",this,t),this}getDefaultScene(){return this.defaultScene?this.defaultScene.getChild():null}Mt(t){return this.addGraphChild(this.nodes,this.graph.link("node",this,t))}listNodes(){return this.nodes.map(t=>t.getChild())}At(t){return this.addGraphChild(this.cameras,this.graph.link("camera",this,t))}listCameras(){return this.cameras.map(t=>t.getChild())}It(t){return this.addGraphChild(this.skins,this.graph.link("skin",this,t))}listSkins(){return this.skins.map(t=>t.getChild())}Et(t){return this.addGraphChild(this.meshes,this.graph.link("mesh",this,t))}listMeshes(){return this.meshes.map(t=>t.getChild())}xt(t){return this.addGraphChild(this.materials,this.graph.link("material",this,t))}listMaterials(){return this.materials.map(t=>t.getChild())}bt(t){return this.addGraphChild(this.textures,this.graph.link("texture",this,t))}listTextures(){return this.textures.map(t=>t.getChild())}Tt(t){return this.addGraphChild(this.animations,this.graph.link("animation",this,t))}listAnimations(){return this.animations.map(t=>t.getChild())}vt(t){return this.addGraphChild(this.accessors,this.graph.link("accessor",this,t))}listAccessors(){return this.accessors.map(t=>t.getChild())}yt(t){return this.addGraphChild(this.buffers,this.graph.link("buffer",this,t))}listBuffers(){return this.buffers.map(t=>t.getChild())}}l([p],nt.prototype,"defaultScene",void 0),l([g],nt.prototype,"accessors",void 0),l([g],nt.prototype,"animations",void 0),l([g],nt.prototype,"buffers",void 0),l([g],nt.prototype,"cameras",void 0),l([g],nt.prototype,"materials",void 0),l([g],nt.prototype,"meshes",void 0),l([g],nt.prototype,"nodes",void 0),l([g],nt.prototype,"scenes",void 0),l([g],nt.prototype,"skins",void 0),l([g],nt.prototype,"textures",void 0);class ht{constructor(){this.Ct=new V,this._t=new nt(this.Ct),this.Ot=I.DEFAULT_INSTANCE}getRoot(){return this._t}getGraph(){return this.Ct}getLogger(){return this.Ot}setLogger(t){return this.Ot=t,this}clone(){return(new ht).merge(this).setLogger(this.Ot)}merge(t){const s={};for(const e of t.getRoot().listExtensionsUsed()){const t=this.createExtension(e.constructor);e.isRequired()&&t.setRequired(!0),s[t.extensionName]=t}const e=new Set,i=new Map;e.add(t._t),i.set(t._t,this._t);for(const r of t.Ct.getLinks())for(const t of[r.getParent(),r.getChild()]){if(e.has(t))continue;let r;if(t.propertyType===o.TEXTURE_INFO)r=t;else{const e=t.constructor;r=t instanceof D?new e(this.Ct,s[t.extensionName]):new e(this.Ct)}i.set(t,r),e.add(t)}const r=t=>{const s=i.get(t);if(!s)throw new Error("Could resolve property.");return s};for(const t of e){const s=i.get(t);if(!s)throw new Error("Could resolve property.");s.copy(t,r)}return this}async transform(...t){for(const s of t)await s(this);return this}createExtension(t){const s=t.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(t=>t.extensionName===s)||new t(this)}createScene(t=""){const s=new et(this.Ct,t);return this._t.St(s),s}createNode(t=""){const s=new X(this.Ct,t);return this._t.Mt(s),s}createCamera(t=""){const s=new j(this.Ct,t);return this._t.At(s),s}createSkin(t=""){const s=new it(this.Ct,t);return this._t.It(s),s}createMesh(t=""){const s=new Q(this.Ct,t);return this._t.Et(s),s}createPrimitive(){return new tt(this.Ct)}createPrimitiveTarget(t=""){return new st(this.Ct,t)}createMaterial(t=""){const s=new K(this.Ct,t);return this._t.xt(s),s}createTexture(t=""){const s=new rt(this.Ct,t);return this._t.bt(s),s}createAnimation(t=""){const s=new U(this.Ct,t);return this._t.Tt(s),s}createAnimationChannel(t=""){return new k(this.Ct,t)}createAnimationSampler(t=""){return new F(this.Ct,t)}createAccessor(t="",s=null){s||(s=this.getRoot().listBuffers()[0]);const e=new P(this.Ct,t).setBuffer(s);return this._t.vt(e),e}createBuffer(t=""){const s=new G(this.Ct,t);return this._t.yt(s),s}}class ot{constructor(t){this.doc=void 0,this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.required=!1,this.properties=new Set,this.doc=t,t.getRoot().Rt(this)}dispose(){this.doc.getRoot().Nt(this);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(t){return this.required=t,this}addExtensionProperty(t){return this.properties.add(t),this}removeExtensionProperty(t){return this.properties.delete(t),this}install(t,s){return this}preread(t,s){return this}prewrite(t,s){return this}}function ut(){return(ut=Object.assign||function(t){for(var s=1;s<arguments.length;s++){var e=arguments[s];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t}).apply(this,arguments)}ot.EXTENSION_NAME=void 0;class ct{constructor(t){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=t}setTextureInfo(t,s){this.textureInfos.set(t,s),void 0!==s.texCoord&&t.setTexCoord(s.texCoord);const e=this.jsonDoc.json.textures[s.index];if(void 0===e.sampler)return;const i=this.jsonDoc.json.samplers[e.sampler];void 0!==i.magFilter&&t.setMagFilter(i.magFilter),void 0!==i.minFilter&&t.setMinFilter(i.minFilter),void 0!==i.wrapS&&t.setWrapS(i.wrapS),void 0!==i.wrapT&&t.setWrapT(i.wrapT)}}const at={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},lt={logger:I.DEFAULT_INSTANCE,extensions:[],dependencies:{}};class ft{static read(t,s=lt){const e=ut({},lt,s),{json:i}=t,r=new ht;this.validate(t,e);const n=new ct(t),h=i.asset,u=r.getRoot().getAsset();h.copyright&&(u.copyright=h.copyright),h.extras&&(u.extras=h.extras),h.generator&&(u.generator=h.generator),h.minVersion&&(u.minVersion=h.minVersion),void 0!==i.extras&&r.getRoot().setExtras(ut({},i.extras));const c=i.extensionsUsed||[],a=i.extensionsRequired||[];for(const t of e.extensions)if(c.includes(t.EXTENSION_NAME)){const s=r.createExtension(t).setRequired(a.includes(t.EXTENSION_NAME));for(const t of s.readDependencies)s.install(t,e.dependencies[t])}const l=i.buffers||[];r.getRoot().listExtensionsUsed().filter(t=>t.prereadTypes.includes(o.BUFFER)).forEach(t=>t.preread(n,o.BUFFER)),n.buffers=l.map(t=>{const s=r.createBuffer(t.name);return t.extras&&s.setExtras(t.extras),t.uri&&0!==t.uri.indexOf("__")&&s.setURI(t.uri),s}),n.bufferViewBuffers=(i.bufferViews||[]).map((s,e)=>{if(!n.bufferViews[e]){const i=t.json.buffers[s.buffer],r=new Uint8Array(i.uri?t.resources[i.uri]:t.resources["@glb.bin"],s.byteOffset||0,s.byteLength);n.bufferViews[e]=r}return n.buffers[s.buffer]}),n.accessors=(i.accessors||[]).map(t=>{const s=r.createAccessor(t.name,n.bufferViewBuffers[t.bufferView]).setType(t.type);if(t.extras&&s.setExtras(t.extras),void 0!==t.normalized&&s.setNormalized(t.normalized),void 0===t.bufferView&&!t.sparse)return s;let e;return e=void 0!==t.sparse?function(t,s){const e=at[t.componentType],i=P.getElementSize(t.type);let r;r=void 0!==t.bufferView?dt(t,s):new e(t.count*i);const n=t.sparse,h=n.count,o=ut({},t,n.indices,{count:h,type:"SCALAR"}),u=ut({},t,n.values,{count:h}),c=dt(o,s),a=dt(u,s);for(let t=0;t<o.count;t++)for(let s=0;s<i;s++)r[c[t]*i+s]=a[t*i+s];return r}(t,n):dt(t,n),s.setArray(e),s});const f=i.images||[],d=i.textures||[];r.getRoot().listExtensionsUsed().filter(t=>t.prereadTypes.includes(o.TEXTURE)).forEach(t=>t.preread(n,o.TEXTURE)),n.textures=f.map(s=>{const e=r.createTexture(s.name);if(s.extras&&e.setExtras(s.extras),void 0!==s.bufferView){const r=i.bufferViews[s.bufferView],n=t.json.buffers[r.buffer],h=r.byteOffset||0,o=(n.uri?t.resources[n.uri]:t.resources["@glb.bin"]).slice(h,h+r.byteLength);e.setImage(o)}else void 0!==s.uri&&(e.setImage(t.resources[s.uri]),0!==s.uri.indexOf("__")&&e.setURI(s.uri));if(void 0!==s.mimeType)e.setMimeType(s.mimeType);else if(s.uri){const t=A.extension(s.uri);e.setMimeType(E.extensionToMimeType(t))}return e}),n.materials=(i.materials||[]).map(t=>{const s=r.createMaterial(t.name);t.extras&&s.setExtras(t.extras),void 0!==t.alphaMode&&s.setAlphaMode(t.alphaMode),void 0!==t.alphaCutoff&&s.setAlphaCutoff(t.alphaCutoff),void 0!==t.doubleSided&&s.setDoubleSided(t.doubleSided);const e=t.pbrMetallicRoughness||{};if(void 0!==e.baseColorFactor&&s.setBaseColorFactor(e.baseColorFactor),void 0!==t.emissiveFactor&&s.setEmissiveFactor(t.emissiveFactor),void 0!==e.metallicFactor&&s.setMetallicFactor(e.metallicFactor),void 0!==e.roughnessFactor&&s.setRoughnessFactor(e.roughnessFactor),void 0!==e.baseColorTexture){const t=e.baseColorTexture;s.setBaseColorTexture(n.textures[d[t.index].source]),n.setTextureInfo(s.getBaseColorTextureInfo(),t)}if(void 0!==t.emissiveTexture){const e=t.emissiveTexture;s.setEmissiveTexture(n.textures[d[e.index].source]),n.setTextureInfo(s.getEmissiveTextureInfo(),e)}if(void 0!==t.normalTexture){const e=t.normalTexture;s.setNormalTexture(n.textures[d[e.index].source]),n.setTextureInfo(s.getNormalTextureInfo(),e),void 0!==t.normalTexture.scale&&s.setNormalScale(t.normalTexture.scale)}if(void 0!==t.occlusionTexture){const e=t.occlusionTexture;s.setOcclusionTexture(n.textures[d[e.index].source]),n.setTextureInfo(s.getOcclusionTextureInfo(),e),void 0!==t.occlusionTexture.strength&&s.setOcclusionStrength(t.occlusionTexture.strength)}if(void 0!==e.metallicRoughnessTexture){const t=e.metallicRoughnessTexture;s.setMetallicRoughnessTexture(n.textures[d[t.index].source]),n.setTextureInfo(s.getMetallicRoughnessTextureInfo(),t)}return s});const p=i.meshes||[];r.getRoot().listExtensionsUsed().filter(t=>t.prereadTypes.includes(o.PRIMITIVE)).forEach(t=>t.preread(n,o.PRIMITIVE)),n.meshes=p.map(t=>{const s=r.createMesh(t.name);return t.extras&&s.setExtras(t.extras),void 0!==t.weights&&s.setWeights(t.weights),(t.primitives||[]).forEach(e=>{const i=r.createPrimitive();e.extras&&i.setExtras(e.extras),void 0!==e.material&&i.setMaterial(n.materials[e.material]),void 0!==e.mode&&i.setMode(e.mode);for(const[t,s]of Object.entries(e.attributes||{}))i.setAttribute(t,n.accessors[s]);void 0!==e.indices&&i.setIndices(n.accessors[e.indices]);const h=t.extras&&t.extras.targetNames||[];(e.targets||[]).forEach((t,s)=>{const e=h[s]||s.toString(),o=r.createPrimitiveTarget(e);for(const[s,e]of Object.entries(t))o.setAttribute(s,n.accessors[e]);i.addTarget(o)}),s.addPrimitive(i)}),s}),n.cameras=(i.cameras||[]).map(t=>{const s=r.createCamera(t.name).setType(t.type);if(t.extras&&s.setExtras(t.extras),t.type===j.Type.PERSPECTIVE){const e=t.perspective;s.setYFov(e.yfov),s.setZNear(e.znear),void 0!==e.zfar&&s.setZFar(e.zfar),void 0!==e.aspectRatio&&s.setAspectRatio(e.aspectRatio)}else{const e=t.orthographic;s.setZNear(e.znear).setZFar(e.zfar).setXMag(e.xmag).setYMag(e.ymag)}return s});const g=i.nodes||[];r.getRoot().listExtensionsUsed().filter(t=>t.prereadTypes.includes(o.NODE)).forEach(t=>t.preread(n,o.NODE)),n.nodes=g.map(t=>{const s=r.createNode(t.name);if(t.extras&&s.setExtras(t.extras),void 0!==t.translation&&s.setTranslation(t.translation),void 0!==t.rotation&&s.setRotation(t.rotation),void 0!==t.scale&&s.setScale(t.scale),void 0!==t.matrix){const e=[0,0,0],i=[0,0,0,1],r=[1,1,1];S.decompose(t.matrix,e,i,r),s.setTranslation(e),s.setRotation(i),s.setScale(r)}return void 0!==t.weights&&s.setWeights(t.weights),s}),n.skins=(i.skins||[]).map(t=>{const s=r.createSkin(t.name);t.extras&&s.setExtras(t.extras),void 0!==t.inverseBindMatrices&&s.setInverseBindMatrices(n.accessors[t.inverseBindMatrices]),void 0!==t.skeleton&&s.setSkeleton(n.nodes[t.skeleton]);for(const e of t.joints)s.addJoint(n.nodes[e]);return s}),g.map((t,s)=>{const e=n.nodes[s];(t.children||[]).forEach(t=>e.addChild(n.nodes[t])),void 0!==t.mesh&&e.setMesh(n.meshes[t.mesh]),void 0!==t.camera&&e.setCamera(n.cameras[t.camera]),void 0!==t.skin&&e.setSkin(n.skins[t.skin])}),n.animations=(i.animations||[]).map(t=>{const s=r.createAnimation(t.name);t.extras&&s.setExtras(t.extras);const e=(t.samplers||[]).map(t=>{const e=r.createAnimationSampler().setInput(n.accessors[t.input]).setOutput(n.accessors[t.output]).setInterpolation(t.interpolation||F.Interpolation.LINEAR);return t.extras&&e.setExtras(t.extras),s.addSampler(e),e});return(t.channels||[]).forEach(t=>{const i=r.createAnimationChannel().setSampler(e[t.sampler]).setTargetNode(n.nodes[t.target.node]).setTargetPath(t.target.path);t.extras&&i.setExtras(t.extras),s.addChannel(i)}),s});const w=i.scenes||[];return r.getRoot().listExtensionsUsed().filter(t=>t.prereadTypes.includes(o.SCENE)).forEach(t=>t.preread(n,o.SCENE)),n.scenes=w.map(t=>{const s=r.createScene(t.name);return t.extras&&s.setExtras(t.extras),(t.nodes||[]).map(t=>n.nodes[t]).forEach(t=>s.addChild(t)),s}),void 0!==i.scene&&r.getRoot().setDefaultScene(n.scenes[i.scene]),r.getRoot().listExtensionsUsed().forEach(t=>t.read(n)),r}static validate(t,s){const e=t.json;if("2.0"!==e.asset.version)throw new Error(`Unsupported glTF version, "${e.asset.version}".`);if(e.extensionsRequired)for(const t of e.extensionsRequired)if(!s.extensions.find(s=>s.EXTENSION_NAME===t))throw new Error(`Missing required extension, "${t}".`);if(e.extensionsUsed)for(const t of e.extensionsUsed)s.extensions.find(s=>s.EXTENSION_NAME===t)||s.logger.warn(`Missing optional extension, "${t}".`)}}function dt(t,s){const e=s.bufferViews[t.bufferView],i=s.jsonDoc.json.bufferViews[t.bufferView],r=at[t.componentType],n=P.getElementSize(t.type),h=r.BYTES_PER_ELEMENT;if(void 0!==i.byteStride&&i.byteStride!==n*h)return function(t,s){const e=s.bufferViews[t.bufferView],i=s.jsonDoc.json.bufferViews[t.bufferView],r=at[t.componentType],n=P.getElementSize(t.type),h=r.BYTES_PER_ELEMENT,o=t.byteOffset||0,u=new r(t.count*n),c=new DataView(e.buffer,e.byteOffset,e.byteLength),a=i.byteStride;for(let s=0;s<t.count;s++)for(let e=0;e<n;e++){const i=o+s*a+e*h;let r;switch(t.componentType){case P.ComponentType.FLOAT:r=c.getFloat32(i,!0);break;case P.ComponentType.UNSIGNED_INT:r=c.getUint32(i,!0);break;case P.ComponentType.UNSIGNED_SHORT:r=c.getUint16(i,!0);break;case P.ComponentType.UNSIGNED_BYTE:r=c.getUint8(i);break;case P.ComponentType.SHORT:r=c.getInt16(i,!0);break;case P.ComponentType.BYTE:r=c.getInt8(i);break;default:throw new Error(`Unexpected componentType "${t.componentType}".`)}u[s*n+e]=r}return u}(t,s);const o=e.byteOffset+(t.byteOffset||0);return new r(e.buffer.slice(o,o+t.count*n*h))}var pt,gt;!function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(pt||(pt={})),function(t){t.ARRAY_BUFFER="ARRAY_BUFFER",t.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",t.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",t.OTHER="OTHER"}(gt||(gt={}));class wt{constructor(t,s,e){this.Lt=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.Bt=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.Lt=t,this.jsonDoc=s,this.options=e;const i=t.getRoot(),r=i.listBuffers().length,n=i.listTextures().length;this.bufferURIGenerator=new vt(r>1,e.basename),this.imageURIGenerator=new vt(n>1,e.basename),this.logger=t.getLogger()}createTextureInfoDef(t,s){const e={magFilter:s.getMagFilter()||void 0,minFilter:s.getMinFilter()||void 0,wrapS:s.getWrapS(),wrapT:s.getWrapT()},i=JSON.stringify(e);this.samplerDefIndexMap.has(i)||(this.samplerDefIndexMap.set(i,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(e));const r={source:this.imageIndexMap.get(t),sampler:this.samplerDefIndexMap.get(i)},n=JSON.stringify(r);this.textureDefIndexMap.has(n)||(this.textureDefIndexMap.set(n,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(r));const h={index:this.textureDefIndexMap.get(n)};return 0!==s.getTexCoord()&&(h.texCoord=s.getTexCoord()),this.textureInfoDefMap.set(s,h),h}createPropertyDef(t){const s={};return t.getName()&&(s.name=t.getName()),Object.keys(t.getExtras()).length>0&&(s.extras=t.getExtras()),s}createAccessorDef(t){const s=this.createPropertyDef(t);return s.type=t.getType(),s.componentType=t.getComponentType(),s.count=t.getCount(),this.Lt.getGraph().listParentLinks(t).some(t=>"POSITION"===t.getName()||"input"===t.getName())&&(s.max=t.getMax([]).map(Math.fround),s.min=t.getMin([]).map(Math.fround)),t.getNormalized()&&(s.normalized=t.getNormalized()),s}createImageData(t,s,e){if(this.options.format===a.GLB)this.imageBufferViews.push(s),t.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:s.byteLength});else{const i=E.mimeTypeToExtension(e.getMimeType());t.uri=this.imageURIGenerator.createURI(e,i),this.jsonDoc.resources[t.uri]=s}}getAccessorUsage(t){const s=this.Bt.get(t);if(s)return s;for(const s of this.Lt.getGraph().listParentLinks(t)){if("inverseBindMatrices"===s.getName())return wt.BufferViewUsage.INVERSE_BIND_MATRICES;if(s instanceof J)return wt.BufferViewUsage.ARRAY_BUFFER;if(s instanceof z)return wt.BufferViewUsage.ELEMENT_ARRAY_BUFFER}return wt.BufferViewUsage.OTHER}addAccessorToUsageGroup(t,s){const e=this.Bt.get(t);if(e&&e!==s)throw new Error(`Accessor with usage "${e}" cannot be reused as "${s}".`);return this.Bt.set(t,s),this}listAccessorUsageGroups(){const t={};for(const[s,e]of Array.from(this.Bt.entries()))t[e]=t[e]||[],t[e].push(s);return t}}wt.BufferViewTarget=pt,wt.BufferViewUsage=gt,wt.USAGE_TO_TARGET={[gt.ARRAY_BUFFER]:pt.ARRAY_BUFFER,[gt.ELEMENT_ARRAY_BUFFER]:pt.ELEMENT_ARRAY_BUFFER};class vt{constructor(t,s){this.multiple=void 0,this.basename=void 0,this.counter=1,this.multiple=t,this.basename=s}createURI(t,s){return t.getURI()?t.getURI():this.multiple?`${this.basename}_${this.counter++}.${s}`:`${this.basename}.${s}`}}const{BufferViewUsage:mt}=wt;class Tt{static write(t,s){const e=t.getRoot(),i={asset:ut({},e.getAsset(),{generator:"glTF-Transform v0.12.16"}),extras:ut({},e.getExtras())},r={json:i,resources:{}},n=new wt(t,r,s),h=s.logger||I.DEFAULT_INSTANCE;for(const e of t.getRoot().listExtensionsUsed())for(const t of e.writeDependencies)e.install(t,s.dependencies[t]);function c(t,s,e,r){const h=[];let o=0;for(const s of t){const t=n.createAccessorDef(s);t.bufferView=i.bufferViews.length;const e=T.pad(s.getArray().buffer);t.byteOffset=o,o+=e.byteLength,h.push(e),n.accessorIndexMap.set(s,i.accessors.length),i.accessors.push(t)}const u={buffer:s,byteOffset:e,byteLength:T.concat(h).byteLength};return r&&(u.target=r),i.bufferViews.push(u),{buffers:h,byteLength:o}}function l(t,s,e){const r=t[0].getCount();let h=0;for(const s of t){const t=n.createAccessorDef(s);t.bufferView=i.bufferViews.length,t.byteOffset=h;const e=s.getElementSize(),r=s.getComponentSize();h+=T.padNumber(e*r),n.accessorIndexMap.set(s,i.accessors.length),i.accessors.push(t)}const o=r*h,u=new ArrayBuffer(o),c=new DataView(u);for(let s=0;s<r;s++){let e=0;for(const i of t){const t=i.getElementSize(),r=i.getComponentSize(),n=i.getComponentType(),o=i.getArray();for(let i=0;i<t;i++){const u=s*h+e+i*r,a=o[s*t+i];switch(n){case P.ComponentType.FLOAT:c.setFloat32(u,a,!0);break;case P.ComponentType.BYTE:c.setInt8(u,a);break;case P.ComponentType.SHORT:c.setInt16(u,a,!0);break;case P.ComponentType.UNSIGNED_BYTE:c.setUint8(u,a);break;case P.ComponentType.UNSIGNED_SHORT:c.setUint16(u,a,!0);break;case P.ComponentType.UNSIGNED_INT:c.setUint32(u,a,!0);break;default:throw new Error("Unexpected component type: "+n)}}e+=T.padNumber(t*r)}}return i.bufferViews.push({buffer:s,byteOffset:e,byteLength:o,byteStride:h,target:wt.BufferViewTarget.ARRAY_BUFFER}),{byteLength:o,buffers:[u]}}const f=new Map;for(const s of t.getGraph().getLinks()){if(s.getParent()===e)continue;const t=s.getChild();if(t instanceof P){const e=f.get(t)||[];e.push(s),f.set(t,e)}}if(i.accessors=[],i.bufferViews=[],i.samplers=[],i.textures=[],i.images=e.listTextures().map((t,s)=>{const e=n.createPropertyDef(t);t.getMimeType()&&(e.mimeType=t.getMimeType());const i=t.getImage();return i&&n.createImageData(e,i,t),n.imageIndexMap.set(t,s),e}),t.getRoot().listExtensionsUsed().filter(t=>t.prewriteTypes.includes(o.ACCESSOR)).forEach(t=>t.prewrite(n,o.ACCESSOR)),e.listAccessors().forEach(t=>{const s=n.accessorUsageGroupedByParent,e=n.accessorParents;if(n.accessorIndexMap.has(t))return;const i=f.get(t)||[],r=n.getAccessorUsage(t);if(n.addAccessorToUsageGroup(t,r),s.has(r)){const s=i[0].getParent(),r=e.get(s)||new Set;r.add(t),e.set(s,r)}}),e.listExtensionsUsed().filter(t=>t.prewriteTypes.includes(o.BUFFER)).forEach(t=>t.prewrite(n,o.BUFFER)),(e.listAccessors().length>0||e.listTextures().length>0||n.otherBufferViews.size>0)&&0===e.listBuffers().length)throw new Error("Buffer required for Document resources, but none was found.");i.buffers=[],e.listBuffers().forEach((t,e)=>{const h=n.createPropertyDef(t),o=n.accessorUsageGroupedByParent,f=n.accessorParents,d=t.listParents().filter(t=>t instanceof P),p=new Set(d),g=[],w=i.buffers.length;let v=0;const m=n.listAccessorUsageGroups();for(const t in m)if(o.has(t))for(const e of Array.from(f.values())){const i=Array.from(e).filter(t=>p.has(t)).filter(s=>n.getAccessorUsage(s)===t);if(i.length)if(t!==mt.ARRAY_BUFFER||s.vertexLayout===u.INTERLEAVED){const s=t===mt.ARRAY_BUFFER?l(i,w,v):c(i,w,v);v+=s.byteLength,g.push(...s.buffers)}else for(const t of i){const s=l([t],w,v);v+=s.byteLength,g.push(...s.buffers)}}else{const s=m[t].filter(t=>p.has(t));if(!s.length)continue;const e=c(s,w,v,t===mt.ELEMENT_ARRAY_BUFFER?wt.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0);v+=e.byteLength,g.push(...e.buffers)}if(n.imageBufferViews.length&&0===e)for(let t=0;t<n.imageBufferViews.length;t++)if(i.bufferViews[i.images[t].bufferView].byteOffset=v,v+=n.imageBufferViews[t].byteLength,g.push(n.imageBufferViews[t]),v%8){const t=8-v%8;v+=t,g.push(new ArrayBuffer(t))}if(n.otherBufferViews.has(t))for(const s of n.otherBufferViews.get(t))i.bufferViews.push({buffer:w,byteOffset:v,byteLength:s.byteLength}),n.otherBufferViewsIndexMap.set(s,i.bufferViews.length-1),v+=s.byteLength,g.push(s);if(v){let e;s.format===a.GLB?e="@glb.bin":(e=n.bufferURIGenerator.createURI(t,"bin"),h.uri=e),h.byteLength=v,r.resources[e]=T.concat(g)}i.buffers.push(h),n.bufferIndexMap.set(t,e)}),e.listAccessors().find(t=>!t.getBuffer())&&h.warn("Skipped writing one or more Accessors: no Buffer assigned."),i.materials=e.listMaterials().map((t,s)=>{const e=n.createPropertyDef(t);if(t.getAlphaMode()!==K.AlphaMode.OPAQUE&&(e.alphaMode=t.getAlphaMode()),t.getAlphaMode()===K.AlphaMode.MASK&&(e.alphaCutoff=t.getAlphaCutoff()),t.getDoubleSided()&&(e.doubleSided=!0),e.pbrMetallicRoughness={},S.eq(t.getBaseColorFactor(),[1,1,1,1])||(e.pbrMetallicRoughness.baseColorFactor=t.getBaseColorFactor()),S.eq(t.getEmissiveFactor(),[0,0,0])||(e.emissiveFactor=t.getEmissiveFactor()),1!==t.getRoughnessFactor()&&(e.pbrMetallicRoughness.roughnessFactor=t.getRoughnessFactor()),1!==t.getMetallicFactor()&&(e.pbrMetallicRoughness.metallicFactor=t.getMetallicFactor()),t.getBaseColorTexture()){const s=t.getBaseColorTexture(),i=t.getBaseColorTextureInfo();e.pbrMetallicRoughness.baseColorTexture=n.createTextureInfoDef(s,i)}if(t.getEmissiveTexture()){const s=t.getEmissiveTexture(),i=t.getEmissiveTextureInfo();e.emissiveTexture=n.createTextureInfoDef(s,i)}if(t.getNormalTexture()){const s=t.getNormalTexture(),i=t.getNormalTextureInfo(),r=n.createTextureInfoDef(s,i);1!==t.getNormalScale()&&(r.scale=t.getNormalScale()),e.normalTexture=r}if(t.getOcclusionTexture()){const s=t.getOcclusionTexture(),i=t.getOcclusionTextureInfo(),r=n.createTextureInfoDef(s,i);1!==t.getOcclusionStrength()&&(r.strength=t.getOcclusionStrength()),e.occlusionTexture=r}if(t.getMetallicRoughnessTexture()){const s=t.getMetallicRoughnessTexture(),i=t.getMetallicRoughnessTextureInfo();e.pbrMetallicRoughness.metallicRoughnessTexture=n.createTextureInfoDef(s,i)}return n.materialIndexMap.set(t,s),e}),i.meshes=e.listMeshes().map((t,s)=>{const e=n.createPropertyDef(t);let i=null;return e.primitives=t.listPrimitives().map(t=>{const s={attributes:{}};s.mode=t.getMode();const e=t.getMaterial();e&&(s.material=n.materialIndexMap.get(e)),Object.keys(t.getExtras()).length&&(s.extras=t.getExtras());const r=t.getIndices();r&&(s.indices=n.accessorIndexMap.get(r));for(const e of t.listSemantics())s.attributes[e]=n.accessorIndexMap.get(t.getAttribute(e));for(const e of t.listTargets()){const t={};for(const s of e.listSemantics())t[s]=n.accessorIndexMap.get(e.getAttribute(s));s.targets=s.targets||[],s.targets.push(t)}return t.listTargets().length&&!i&&(i=t.listTargets().map(t=>t.getName())),s}),t.getWeights().length&&(e.weights=t.getWeights()),i&&(e.extras=e.extras||{},e.extras.targetNames=i),n.meshIndexMap.set(t,s),e}),i.cameras=e.listCameras().map((t,s)=>{const e=n.createPropertyDef(t);if(e.type=t.getType(),e.type===j.Type.PERSPECTIVE){e.perspective={znear:t.getZNear(),zfar:t.getZFar(),yfov:t.getYFov()};const s=t.getAspectRatio();null!==s&&(e.perspective.aspectRatio=s)}else e.orthographic={znear:t.getZNear(),zfar:t.getZFar(),xmag:t.getXMag(),ymag:t.getYMag()};return n.cameraIndexMap.set(t,s),e}),i.nodes=e.listNodes().map((t,s)=>{const e=n.createPropertyDef(t);return S.eq(t.getTranslation(),[0,0,0])||(e.translation=t.getTranslation()),S.eq(t.getRotation(),[0,0,0,1])||(e.rotation=t.getRotation()),S.eq(t.getScale(),[1,1,1])||(e.scale=t.getScale()),t.getWeights().length&&(e.weights=t.getWeights()),n.nodeIndexMap.set(t,s),e}),i.skins=e.listSkins().map((t,s)=>{const e=n.createPropertyDef(t),i=t.getInverseBindMatrices();i&&(e.inverseBindMatrices=n.accessorIndexMap.get(i));const r=t.getSkeleton();return r&&(e.skeleton=n.nodeIndexMap.get(r)),e.joints=t.listJoints().map(t=>n.nodeIndexMap.get(t)),n.skinIndexMap.set(t,s),e}),e.listNodes().forEach((t,s)=>{const e=i.nodes[s],r=t.getMesh();r&&(e.mesh=n.meshIndexMap.get(r));const h=t.getCamera();h&&(e.camera=n.cameraIndexMap.get(h));const o=t.getSkin();o&&(e.skin=n.skinIndexMap.get(o)),t.listChildren().length>0&&(e.children=t.listChildren().map(t=>n.nodeIndexMap.get(t)))}),i.animations=e.listAnimations().map(t=>{const s=n.createPropertyDef(t),e=new Map;return s.samplers=t.listSamplers().map((t,s)=>{const i=n.createPropertyDef(t);return i.input=n.accessorIndexMap.get(t.getInput()),i.output=n.accessorIndexMap.get(t.getOutput()),i.interpolation=t.getInterpolation(),e.set(t,s),i}),s.channels=t.listChannels().map(t=>{const s=n.createPropertyDef(t);return s.sampler=e.get(t.getSampler()),s.target={node:n.nodeIndexMap.get(t.getTargetNode()),path:t.getTargetPath()},s}),s}),i.scenes=e.listScenes().map(t=>{const s=n.createPropertyDef(t);return s.nodes=t.listChildren().map(t=>n.nodeIndexMap.get(t)),s});const d=e.getDefaultScene();return d&&(i.scene=e.listScenes().indexOf(d)),i.extensionsUsed=e.listExtensionsUsed().map(t=>t.extensionName),i.extensionsRequired=e.listExtensionsRequired().map(t=>t.extensionName),e.listExtensionsUsed().forEach(t=>t.write(n)),function(t){const s=[];for(const e in t){const i=t[e];(Array.isArray(i)&&0===i.length||null===i||""===i||i&&"object"==typeof i&&0===Object.keys(i).length)&&s.push(e)}for(const e of s)delete t[e]}(i),r}}var yt;!function(t){t[t.JSON=1313821514]="JSON",t[t.BIN=5130562]="BIN"}(yt||(yt={}));class At{constructor(){this.Ot=I.DEFAULT_INSTANCE,this.gt=[],this.Pt={},this.Ut=u.INTERLEAVED}setLogger(t){return this.Ot=t,this}registerExtensions(t){for(const s of t)this.gt.push(s),s.register();return this}registerDependencies(t){return Object.assign(this.Pt,t),this}setVertexLayout(t){return this.Ut=t,this}kt(t){function s(s){if(s.uri&&!(s.uri in t.resources)&&s.uri.match(/data:/)){const e=`__${C()}.${A.extension(s.uri)}`;t.resources[e]=T.createBufferFromDataURI(s.uri),s.uri=e}}(t.json.images||[]).forEach(t=>{if(void 0===t.bufferView&&void 0===t.uri)throw new Error("Missing resource URI or buffer view.");s(t)}),(t.json.buffers||[]).forEach(s)}readJSON(t){return this.kt(t),ft.read(t,{extensions:this.gt,dependencies:this.Pt,logger:this.Ot})}writeJSON(t,s={}){if(s.format===a.GLB&&t.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return Tt.write(t,{format:s.format||a.GLTF,logger:s.logger||this.Ot,vertexLayout:s.vertexLayout||this.Ut,dependencies:ut({},this.Pt,s.dependencies),basename:s.basename||""})}binaryToJSON(t){const s=this.Ft(t),e=s.json;if(e.buffers&&e.buffers.find(t=>void 0!==t.uri))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(e.images&&e.images.find(t=>void 0===t.bufferView))throw new Error("Cannot resolve external images with binaryToJSON().");return s}Ft(t){const s=new Uint32Array(t,0,3);if(1179937895!==s[0])throw new Error("Invalid glTF asset.");if(2!==s[1])throw new Error(`Unsupported glTF binary version, "${s[1]}".`);const e=new Uint32Array(t,12,2);if(e[1]!==yt.JSON)throw new Error("Missing required GLB JSON chunk.");const i=e[0],r=T.decodeText(t.slice(20,20+i)),n=JSON.parse(r),h=20+i;if(t.byteLength<=h)return{json:n,resources:{}};const o=new Uint32Array(t,h,2);if(o[1]!==yt.BIN)throw new Error("Expected GLB BIN in second chunk.");return{json:n,resources:{"@glb.bin":t.slice(h+8,h+8+o[0])}}}readBinary(t){return this.readJSON(this.binaryToJSON(t))}writeBinary(t){const{json:s,resources:e}=this.writeJSON(t,{format:a.GLB,basename:"",logger:this.Ot,dependencies:this.Pt,vertexLayout:this.Ut}),i=new Uint32Array([1179937895,2,12]),r=JSON.stringify(s),n=T.pad(T.encodeText(r),32),h=new Uint32Array([n.byteLength,1313821514]).buffer,o=T.concat([h,n]);i[i.length-1]+=o.byteLength;const u=Object.values(e)[0];if(!u||!u.byteLength)return T.concat([i.buffer,o]);const c=T.pad(u,0),l=new Uint32Array([c.byteLength,5130562]).buffer,f=T.concat([l,c]);return i[i.length-1]+=f.byteLength,T.concat([i.buffer,o,f])}}class xt extends At{constructor(){super(),this.Gt=void 0,this.jt=void 0,this.lastReadBytes=0,this.lastWriteBytes=0,this.Gt=require("fs"),this.jt=require("path")}read(t){const s=this.readAsJSON(t);return ft.read(s,{extensions:this.gt,dependencies:this.Pt,logger:this.Ot})}readAsJSON(t){return t.match(/\.glb$/)||t.match(/^data:application\/octet-stream;/)?this.Dt(t):this.Jt(t)}write(t,s){t.match(/\.glb$/)?this.zt(t,s):this.$t(t,s)}Vt(t,s){[...t.json.images||[],...t.json.buffers||[]].forEach(e=>{if(e.uri&&!e.uri.match(/data:/)){const i=this.jt.resolve(s,e.uri);t.resources[e.uri]=T.trim(this.Gt.readFileSync(i)),this.lastReadBytes+=t.resources[e.uri].byteLength}})}Dt(t){const s=this.Gt.readFileSync(t),e=T.trim(s);this.lastReadBytes=e.byteLength;const i=this.Ft(e);return this.Vt(i,this.jt.dirname(t)),this.kt(i),i}Jt(t){this.lastReadBytes=0;const s=this.Gt.readFileSync(t,"utf8");this.lastReadBytes+=s.length;const e={json:JSON.parse(s),resources:{}};return this.Vt(e,this.jt.dirname(t)),this.kt(e),e}$t(t,s){this.lastWriteBytes=0;const{json:e,resources:i}=Tt.write(s,{format:a.GLTF,logger:this.Ot,dependencies:this.Pt,vertexLayout:this.Ut,basename:A.basename(t)}),{Gt:r,jt:n}=this,h=n.dirname(t),o=JSON.stringify(e,null,2);this.lastWriteBytes+=o.length,r.writeFileSync(t,o),Object.keys(i).forEach(t=>{const s=Buffer.from(i[t]);r.writeFileSync(n.join(h,t),s),this.lastWriteBytes+=s.byteLength})}zt(t,s){const e=Buffer.from(this.writeBinary(s));this.Gt.writeFileSync(t,e),this.lastWriteBytes=e.byteLength}}const Et={};class Mt extends At{constructor(t=Et){super(),this.Wt=void 0,this.Wt=t}read(t){return this.readAsJSON(t).then(t=>this.readJSON(t))}readAsJSON(t){return t.match(/^data:application\/octet-stream;/)||new URL(t,window.location.href).pathname.match(/\.glb$/)?this.Dt(t):this.Jt(t)}Vt(t,s){const e=[...t.json.images||[],...t.json.buffers||[]].map(e=>{const i=e.uri;return!i||i.match(/data:/)?Promise.resolve():fetch(function(t,s){if(!function(t){return!/^(?:[a-zA-Z]+:)?\//.test(t)}(s))return s;const e=t.split("/"),i=s.split("/");e.pop();for(let t=0;t<i.length;t++)"."!==i[t]&&(".."===i[t]?e.pop():e.push(i[t]));return e.join("/")}(s,i),this.Wt).then(t=>t.arrayBuffer()).then(s=>{t.resources[i]=s})});return Promise.all(e).then(()=>{})}Jt(t){var s=this;const e={json:{},resources:{}};return fetch(t,this.Wt).then(t=>t.json()).then(async function(i){return e.json=i,await s.Vt(e,St(t)),s.kt(e),e})}Dt(t){var s=this;return fetch(t,this.Wt).then(t=>t.arrayBuffer()).then(async function(e){const i=s.Ft(e);return await s.Vt(i,St(t)),s.kt(i),i})}}function St(t){const s=t.lastIndexOf("/");return-1===s?"./":t.substr(0,s+1)}export{P as Accessor,U as Animation,k as AnimationChannel,F as AnimationSampler,J as AttributeLink,G as Buffer,T as BufferUtils,_ as COPY_IDENTITY,j as Camera,y as ColorUtils,ht as Document,ot as Extension,D as ExtensionProperty,A as FileUtils,a as Format,h as GLB_BUFFER,d as Graph,p as GraphChild,g as GraphChildList,E as ImageUtils,z as IndexLink,f as Link,I as Logger,K as Material,S as MathUtils,Q as Mesh,X as Node,xt as NodeIO,At as PlatformIO,tt as Primitive,st as PrimitiveTarget,O as Property,o as PropertyType,ct as ReaderContext,nt as Root,et as Scene,it as Skin,rt as Texture,c as TextureChannel,W as TextureInfo,$ as TextureLink,n as VERSION,u as VertexLayout,Mt as WebIO,wt as WriterContext,w as bounds,C as uuid};
//# sourceMappingURL=core.modern.js.map
